<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ëŒ€í•™ë³„ í‰ê· ë“±ë¡ê¸ˆ</title>
    <link rel="icon" type="image/png" sizes="180x180" href="/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">
    <link rel="stylesheet" href="../../css/common.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <header>
        <div class="container">
            <h1>ëŒ€í•™ë³„ í‰ê· ë“±ë¡ê¸ˆ</h1>
            <a href="../../index.html" class="back-btn">â† ë’¤ë¡œ</a>
        </div>
    </header>

    <main>
        <div class="container">
            <div class="controls-area">
                <div class="search-filter">
                    <select id="categoryFilter">
                        <option value="">í•™ì œë³„: ì „ì²´</option>
                        <option value="ëŒ€í•™">ëŒ€í•™</option>
                        <option value="ì „ë¬¸ëŒ€í•™">ì „ë¬¸ëŒ€í•™</option>
                    </select>
                    <select id="establishmentFilter">
                        <option value="">ì„¤ë¦½ë³„: ì „ì²´</option>
                        <option value="êµ­ê³µë¦½">êµ­ê³µë¦½</option>
                        <option value="ì‚¬ë¦½">ì‚¬ë¦½</option>
                    </select>
                    <input type="text" id="searchInput" placeholder="ëŒ€í•™ëª… ê²€ìƒ‰">
                    <select id="regionFilter">
                        <option value="">ì§€ì—­ë³„: ì „ì²´</option>
                        <option value="ê°•ì›">ê°•ì›</option>
                        <option value="ê²½ê¸°">ê²½ê¸°</option>
                        <option value="ê²½ë‚¨">ê²½ë‚¨</option>
                        <option value="ê²½ë¶">ê²½ë¶</option>
                        <option value="ê´‘ì£¼">ê´‘ì£¼</option>
                        <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
                        <option value="ëŒ€ì „">ëŒ€ì „</option>
                        <option value="ë¶€ì‚°">ë¶€ì‚°</option>
                        <option value="ì„œìš¸">ì„œìš¸</option>
                        <option value="ì„¸ì¢…">ì„¸ì¢…</option>
                        <option value="ìš¸ì‚°">ìš¸ì‚°</option>
                        <option value="ì¸ì²œ">ì¸ì²œ</option>
                        <option value="ì „ë‚¨">ì „ë‚¨</option>
                        <option value="ì „ë¶">ì „ë¶</option>
                        <option value="ì œì£¼">ì œì£¼</option>
                        <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
                        <option value="ì¶©ë¶">ì¶©ë¶</option>
                    </select>
                    <select id="itemsPerPage">
                        <option value="10" selected>10ê°œ</option>
                        <option value="20">20ê°œ</option>
                        <option value="30">30ê°œ</option>
                        <option value="40">40ê°œ</option>
                        <option value="50">50ê°œ</option>
                        <option value="60">60ê°œ</option>
                        <option value="70">70ê°œ</option>
                        <option value="80">80ê°œ</option>
                        <option value="90">90ê°œ</option>
                        <option value="100">100ê°œ</option>
                    </select>
                    <button id="downloadCsvBtn" title="ë°ì´í„° ë‹¤ìš´ë¡œë“œ" disabled>
                        <i class="fas fa-file-csv"></i> CSV ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                <div class="results-info" id="resultsInfo">
                    ì´ <span id="totalCount">0</span>ê°œ ì¤‘ <span id="currentRange">0-0</span>ê°œ í‘œì‹œ ì¤‘
                </div>
            </div>
            <div class="chart-container">
                <canvas id="regionChart"></canvas>
            </div>
            <div class="loader" id="loader">
                <i class="fas fa-spinner fa-2x"></i>
                <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div class="no-results" id="noResults">
                <i class="fas fa-search"></i>
                <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë‚˜ í•„í„° ì¡°ê±´ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>
            </div>
            <div class="table-view" id="tableView">
                <table id="universityTable">
                    <thead>
                        <tr>
                            <th data-sort="í•™ì œë³„">í•™ì œë³„ <i class="fas fa-sort"></i></th>
                            <th data-sort="ì„¤ë¦½ë³„">ì„¤ë¦½ë³„ <i class="fas fa-sort"></i></th>
                            <th data-sort="ëŒ€í•™ëª…">ëŒ€í•™ëª… <i class="fas fa-sort"></i></th>
                            <th data-sort="ì§€ì—­ë³„">ì§€ì—­ë³„ <i class="fas fa-sort"></i></th>
                            <th data-sort="ì…í•™ì •ì›">ì…í•™ì •ì› <i class="fas fa-sort"></i></th>
                            <th data-sort="í‰ê· ì…í•™ê¸ˆ">í‰ê· ì…í•™ê¸ˆ <i class="fas fa-sort"></i></th>
                            <th data-sort="í‰ê· ë“±ë¡ê¸ˆ(ì›)">í‰ê· ë“±ë¡ê¸ˆ(ì›) <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
            <div class="pagination" id="pagination"></div>
        </div>
    </main>

    <style>
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .controls-area {
            margin-bottom: 20px;
        }

        .search-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .search-filter input,
        .search-filter select {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .search-filter input {
            flex: 1;
            min-width: 200px;
        }

        #downloadCsvBtn {
            padding: 10px 15px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #downloadCsvBtn:hover {
            background-color: #229a53;
        }

        .results-info {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
        }

        .chart-container {
            margin-bottom: 20px;
            max-width: 100%;
            height: 300px;
        }

        .table-view {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f4f4f4;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background-color: #e0e0e0;
        }

        th i {
            margin-left: 5px;
            opacity: 0.5;
        }

        th i.active {
            opacity: 1;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        td[data-fulltext] {
            cursor: pointer;
        }

        .loader {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loader i {
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            display: none;
        }

        .no-results i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }

        th[data-sort="ëŒ€í•™ëª…"],
        td:nth-child(3) {
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .search-filter input,
            .search-filter select {
                width: 100%;
            }

            th,
            td {
                padding: 8px;
                font-size: 14px;
            }

            .pagination button:not(.prev):not(.next):not(.active) {
                display: none;
            }
        }
    </style>

    <!-- Chart.js CDN (ë²„ì „ 4.x ê¸°ì¤€ ìµœì‹ ) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let universities = [];
        let filteredUniversities = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortKey = 'ëŒ€í•™ëª…';
        let sortOrder = 1;

        const tableBody = document.getElementById('tableBody');
        const tableView = document.getElementById('tableView');
        const loader = document.getElementById('loader');
        const noResults = document.getElementById('noResults');
        const resultsInfo = document.getElementById('resultsInfo');
        const totalCount = document.getElementById('totalCount');
        const currentRange = document.getElementById('currentRange');
        const pagination = document.getElementById('pagination');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        const ctx = document.getElementById('regionChart').getContext('2d');
        let chartInstance = null;

        function showLoader(show) {
            loader.style.display = show ? 'block' : 'none';
            tableView.style.display = show ? 'none' : 'block';
            noResults.style.display = 'none';
            pagination.style.display = show ? 'none' : 'flex';
        }

        function showNoResults(show) {
            noResults.style.display = show ? 'block' : 'none';
            tableView.style.display = show ? 'none' : 'block';
            pagination.style.display = show ? 'none' : 'flex';
        }

        function updateResultsInfo() {
            totalCount.textContent = filteredUniversities.length;
            const start = (currentPage - 1) * itemsPerPage + 1;
            const end = Math.min(start + itemsPerPage - 1, filteredUniversities.length);
            currentRange.textContent = filteredUniversities.length > 0 ? `${start}-${end}` : '0-0';
        }

        function truncateText(text, maxLength) {
            if (text.length > maxLength) {
                return text.substring(0, maxLength) + '...';
            }
            return text;
        }

        function renderTableRows(universitiesToRender) {
            tableBody.innerHTML = '';
            const isMobile = window.innerWidth <= 768;
            const maxLengths = {
                'í•™ì œë³„': 10,
                'ì„¤ë¦½ë³„': 10,
                'ëŒ€í•™ëª…': 20,
                'ì§€ì—­ë³„': 10,
                'ì…í•™ì •ì›': 10,
                'í‰ê· ì…í•™ê¸ˆ': 10,
                'í‰ê· ë“±ë¡ê¸ˆ(ì›)': 12
            };

            universitiesToRender.forEach(univ => {
                const row = document.createElement('tr');
                row.innerHTML = `
        <td data-fulltext="${univ['í•™ì œë³„']}">${isMobile ? truncateText(univ['í•™ì œë³„'], maxLengths['í•™ì œë³„']) : univ['í•™ì œë³„']}</td>
        <td data-fulltext="${univ['ì„¤ë¦½ë³„']}">${isMobile ? truncateText(univ['ì„¤ë¦½ë³„'], maxLengths['ì„¤ë¦½ë³„']) : univ['ì„¤ë¦½ë³„']}</td>
        <td data-fulltext="${univ['ëŒ€í•™ëª…']}">${isMobile ? truncateText(univ['ëŒ€í•™ëª…'], maxLengths['ëŒ€í•™ëª…']) : univ['ëŒ€í•™ëª…']}</td>
        <td data-fulltext="${univ['ì§€ì—­ë³„']}">${isMobile ? truncateText(univ['ì§€ì—­ë³„'], maxLengths['ì§€ì—­ë³„']) : univ['ì§€ì—­ë³„']}</td>
        <td data-fulltext="${univ['ì…í•™ì •ì›'].toLocaleString()}">${isMobile ? truncateText(univ['ì…í•™ì •ì›'].toLocaleString(), maxLengths['ì…í•™ì •ì›']) : univ['ì…í•™ì •ì›'].toLocaleString()}</td>
        <td data-fulltext="${univ['í‰ê· ì…í•™ê¸ˆ'].toLocaleString()}">${isMobile ? truncateText(univ['í‰ê· ì…í•™ê¸ˆ'].toLocaleString(), maxLengths['í‰ê· ì…í•™ê¸ˆ']) : univ['í‰ê· ì…í•™ê¸ˆ'].toLocaleString()}</td>
        <td data-fulltext="${Math.floor(univ['í‰ê· ë“±ë¡ê¸ˆ(ì›)']).toLocaleString()}">${isMobile ? truncateText(Math.floor(univ['í‰ê· ë“±ë¡ê¸ˆ(ì›)']).toLocaleString(), maxLengths['í‰ê· ë“±ë¡ê¸ˆ(ì›)']) : Math.floor(univ['í‰ê· ë“±ë¡ê¸ˆ(ì›)']).toLocaleString()}</td>
      `;
                row.querySelectorAll('td[data-fulltext]').forEach(td => {
                    if (isMobile && td.textContent.endsWith('...')) {
                        td.style.cursor = 'pointer';
                        td.addEventListener('click', () => {
                            td.textContent = td.textContent.endsWith('...') ? td.dataset.fulltext : truncateText(td.dataset.fulltext, maxLengths[td.cellIndex]);
                        });
                    }
                });
                tableBody.appendChild(row);
            });
        }

        function renderPagination() {
            pagination.innerHTML = '';
            const pageCount = Math.ceil(filteredUniversities.length / itemsPerPage);
            if (pageCount <= 1) {
                pagination.style.display = 'none';
                return;
            }
            pagination.style.display = 'flex';

            const prevButton = document.createElement('button');
            prevButton.classList.add('prev');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.disabled = currentPage === 1;
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderUniversities();
                }
            });
            pagination.appendChild(prevButton);

            const maxVisible = window.innerWidth > 768 ? 10 : 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(pageCount, startPage + maxVisible - 1);
            if (endPage - startPage + 1 < maxVisible) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.classList.toggle('active', i === currentPage);
                button.addEventListener('click', () => {
                    currentPage = i;
                    renderUniversities();
                });
                pagination.appendChild(button);
            }

            const nextButton = document.createElement('button');
            nextButton.classList.add('next');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.disabled = currentPage === pageCount;
            nextButton.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage++;
                    renderUniversities();
                }
            });
            pagination.appendChild(nextButton);
        }

        function renderUniversities() {
            if (filteredUniversities.length === 0) {
                showNoResults(true);
                return;
            }
            showNoResults(false);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedUniversities = filteredUniversities.slice(start, end);
            renderTableRows(paginatedUniversities);
            updateResultsInfo();
            renderPagination();
            updateChart();
        }

        function filterUniversities() {
            const category = document.getElementById('categoryFilter').value;
            const establishment = document.getElementById('establishmentFilter').value;
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const region = document.getElementById('regionFilter').value;

            filteredUniversities = universities.filter(univ => {
                return (!category || univ['í•™ì œë³„'] === category) &&
                    (!establishment || univ['ì„¤ë¦½ë³„'] === establishment) &&
                    (!searchValue || univ['ëŒ€í•™ëª…'].toLowerCase().includes(searchValue)) &&
                    (!region || univ['ì§€ì—­ë³„'] === region);
            });

            sortUniversities();
            currentPage = 1;
            renderUniversities();
        }

        function sortUniversities() {
            filteredUniversities.sort((a, b) => {
                const valueA = a[sortKey] || '';
                const valueB = b[sortKey] || '';
                if (sortKey === 'ì…í•™ì •ì›' || sortKey === 'í‰ê· ì…í•™ê¸ˆ' || sortKey === 'í‰ê· ë“±ë¡ê¸ˆ(ì›)') {
                    return sortOrder * (valueA - valueB);
                }
                return sortOrder * valueA.toString().localeCompare(valueB.toString());
            });
        }

        function updateSortIndicators() {
            document.querySelectorAll('th i').forEach(icon => {
                icon.className = 'fas fa-sort';
                icon.classList.remove('active');
            });
            const currentTh = document.querySelector(`th[data-sort="${sortKey}"]`);
            if (currentTh) {
                const icon = currentTh.querySelector('i');
                icon.className = sortOrder === 1 ? 'fas fa-sort-up active' : 'fas fa-sort-down active';
            }
        }

        function formatDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}_${hours}${minutes}${seconds}`;
        }

        function downloadCsv() {
            if (!filteredUniversities.length) {
                alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const headers = ['í•™ì œë³„', 'ì„¤ë¦½ë³„', 'ëŒ€í•™ëª…', 'ì§€ì—­ë³„', 'ì…í•™ì •ì›', 'í‰ê· ì…í•™ê¸ˆ', 'í‰ê· ë“±ë¡ê¸ˆ(ì›)'];
            const rows = filteredUniversities.map(univ => [
                `"${univ['í•™ì œë³„'].replace(/"/g, '""')}"`,
                `"${univ['ì„¤ë¦½ë³„'].replace(/"/g, '""')}"`,
                `"${univ['ëŒ€í•™ëª…'].replace(/"/g, '""')}"`,
                `"${univ['ì§€ì—­ë³„'].replace(/"/g, '""')}"`,
                univ['ì…í•™ì •ì›'],
                univ['í‰ê· ì…í•™ê¸ˆ'],
                Math.floor(univ['í‰ê· ë“±ë¡ê¸ˆ(ì›)'])
            ]);
            let csvContent = '\uFEFF' + headers.join(',') + '\n';
            rows.forEach(row => csvContent += row.join(',') + '\n');
            const blob = new Blob([csvContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `ëŒ€í•™ë³„_í‰ê· ë“±ë¡ê¸ˆ_${formatDateTime()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function updateChart() {
            const regions = [...new Set(universities.map(u => u['ì§€ì—­ë³„']))].sort();
            const regionAverages = regions.map(region => {
                const regionData = filteredUniversities.filter(u => u['ì§€ì—­ë³„'] === region);
                const totalTuition = regionData.reduce((sum, u) => sum + u['í‰ê· ë“±ë¡ê¸ˆ(ì›)'], 0);
                return regionData.length ? Math.floor(totalTuition / regionData.length) : 0;
            });

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: regions,
                    datasets: [{
                        label: 'í‰ê·  ë“±ë¡ê¸ˆ (ì›)',
                        data: regionAverages,
                        backgroundColor: '#3498db',
                        borderColor: '#2980b9',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'í‰ê·  ë“±ë¡ê¸ˆ (ì›)' }
                        },
                        x: {
                            title: { display: true, text: 'ì§€ì—­' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        showLoader(true);
        fetch('./js/universities.json')
            .then(response => response.json())
            .then(data => {
                universities = data;
                filteredUniversities = [...universities];
                downloadCsvBtn.disabled = false;
                filterUniversities();
                showLoader(false);
            })
            .catch(error => {
                console.error('JSON ë¡œë“œ ì‹¤íŒ¨:', error);
                showLoader(false);
                showNoResults(true);
            });

        document.getElementById('categoryFilter').addEventListener('change', filterUniversities);
        document.getElementById('establishmentFilter').addEventListener('change', filterUniversities);
        document.getElementById('searchInput').addEventListener('input', () => {
            clearTimeout(window.debounceTimeout);
            window.debounceTimeout = setTimeout(filterUniversities, 300);
        });
        document.getElementById('regionFilter').addEventListener('change', filterUniversities);
        document.getElementById('itemsPerPage').addEventListener('change', () => {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1;
            renderUniversities();
        });
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const newSortKey = th.dataset.sort;
                if (newSortKey === sortKey) {
                    sortOrder *= -1;
                } else {
                    sortKey = newSortKey;
                    sortOrder = 1;
                }
                updateSortIndicators();
                filterUniversities();
            });
        });
        downloadCsvBtn.addEventListener('click', downloadCsv);
        updateSortIndicators();
    </script>

    <footer>
        <div class="container">
            í•œ ê±¸ìŒì”©, ê¿ˆì„ í–¥í•´ ğŸŒŸ
        </div>
    </footer>
</body>

</html>